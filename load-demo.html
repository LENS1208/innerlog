<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>デモデータ投入</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin-top: 0;
      color: #333;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #2563eb;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #log {
      margin-top: 20px;
      padding: 15px;
      background: #f8f8f8;
      border-radius: 8px;
      font-family: monospace;
      font-size: 13px;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .success {
      color: #22c55e;
      font-weight: bold;
    }
    .error {
      color: #ef4444;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>デモデータ投入ツール</h1>
    <p>このツールは、デモデータ（A/B/C）をSupabaseデータベースに投入します。</p>
    <button id="loadBtn">デモデータを投入する</button>
    <div id="log"></div>
  </div>

  <script type="module">
    import { supabase } from './src/lib/supabase.ts';

    const logEl = document.getElementById('log');
    const btnEl = document.getElementById('loadBtn');

    function log(msg, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
      logEl.innerHTML += `<div class="${className}">[${timestamp}] ${msg}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function parseCsv(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split('\t');
      const trades = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split('\t');
        if (values.length < headers.length) continue;

        const trade = {
          ticket: values[0],
          pair: values[1],
          side: values[2].toLowerCase(),
          size: parseFloat(values[3]) || 0,
          openTime: values[4],
          openPrice: parseFloat(values[5]) || 0,
          closeTime: values[6],
          closePrice: parseFloat(values[7]) || 0,
          sl: parseFloat(values[8]) || null,
          tp: parseFloat(values[9]) || null,
          commission: parseFloat(values[10]) || 0,
          swap: parseFloat(values[11]) || 0,
          profitYen: parseFloat(values[12]) || 0,
          datetime: values[6],
        };

        const priceDiff = trade.side === 'buy'
          ? (trade.closePrice - trade.openPrice)
          : (trade.openPrice - trade.closePrice);

        let pipMultiplier = 100;
        if (trade.pair.includes('JPY')) {
          pipMultiplier = 1;
        }

        trade.pips = priceDiff * pipMultiplier;

        trades.push(trade);
      }

      return trades;
    }

    async function loadDemoData() {
      btnEl.disabled = true;
      logEl.innerHTML = '';
      log('デモデータの投入を開始します...');

      const datasets = ['A', 'B', 'C'];

      for (const dataset of datasets) {
        try {
          log(`\nデモ${dataset}を処理中...`);

          const response = await fetch(`/demo/${dataset}.csv`);
          if (!response.ok) {
            log(`デモ${dataset}.csvが見つかりません`, 'error');
            continue;
          }

          const csvText = await response.text();
          const trades = parseCsv(csvText);

          log(`${trades.length}件のトレードを解析しました`);

          const { data: existing, error: checkError } = await supabase
            .from('trades')
            .select('id')
            .eq('dataset', dataset)
            .limit(1);

          if (checkError) {
            log(`チェックエラー: ${checkError.message}`, 'error');
            continue;
          }

          if (existing && existing.length > 0) {
            log(`デモ${dataset}は既に存在します。削除して再投入します...`);
            const { error: deleteError } = await supabase
              .from('trades')
              .delete()
              .eq('dataset', dataset);

            if (deleteError) {
              log(`削除エラー: ${deleteError.message}`, 'error');
              continue;
            }
          }

          const tradeRecords = trades.map(trade => ({
            ticket: trade.ticket,
            item: trade.pair,
            side: trade.side,
            size: trade.size,
            open_time: trade.openTime,
            open_price: trade.openPrice,
            close_time: trade.closeTime,
            close_price: trade.closePrice,
            sl: trade.sl,
            tp: trade.tp,
            commission: trade.commission,
            swap: trade.swap,
            profit: trade.profitYen,
            pips: trade.pips,
            dataset: dataset,
          }));

          const batchSize = 100;
          let inserted = 0;

          for (let i = 0; i < tradeRecords.length; i += batchSize) {
            const batch = tradeRecords.slice(i, i + batchSize);
            const { error: insertError } = await supabase
              .from('trades')
              .insert(batch);

            if (insertError) {
              log(`バッチ挿入エラー (${i}-${i + batch.length}): ${insertError.message}`, 'error');
            } else {
              inserted += batch.length;
              log(`${inserted}/${tradeRecords.length}件挿入完了`);
            }
          }

          log(`✓ デモ${dataset}: ${inserted}件のトレードを投入しました`, 'success');
        } catch (error) {
          log(`デモ${dataset}のエラー: ${error.message}`, 'error');
        }
      }

      log('\nデモデータの投入が完了しました！', 'success');
      btnEl.disabled = false;
    }

    btnEl.addEventListener('click', loadDemoData);
  </script>
</body>
</html>
