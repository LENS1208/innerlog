/*
  # デモデータの挿入（最終版）

  1. 目的
    - テストユーザー用のデモトレードデータを挿入
    - 3つのデータセット（A, B, C）を作成
    - 実際の取引パターンを反映

  2. データの詳細
    - Dataset A: 1月、10トレード、100%勝率、+652,000 JPY
    - Dataset B: 2月、15トレード、66.7%勝率、+395,500 JPY
    - Dataset C: 3月、20トレード、50%勝率、+174,000 JPY
    - 合計: 45トレード

  3. セキュリティ
    - 特定のテストユーザーのみ対象
    - RLSポリシーを尊重
*/

-- ユーザーIDを変数に設定
DO $$
DECLARE
  test_user_id uuid := 'cbcc1f55-2f10-41a5-96c4-c2d316ab1fd2';
BEGIN
  -- 既存のデモデータを削除
  DELETE FROM trades WHERE user_id = test_user_id AND dataset IN ('A', 'B', 'C');

  -- Dataset A: 1月 2025、10トレード、100%勝率
  INSERT INTO trades (user_id, ticket, item, side, size, open_time, open_price, close_time, close_price, sl, tp, commission, swap, profit, pips, dataset) VALUES
  (test_user_id, '101001', 'USDJPY', 'buy', 1.0, '2025-01-02 09:00:00+00', 148.500, '2025-01-02 15:30:00+00', 149.200, 148.200, 149.500, -12, 1.5, 68000, 70.0, 'A'),
  (test_user_id, '101002', 'EURUSD', 'sell', 1.5, '2025-01-03 10:15:00+00', 1.09500, '2025-01-03 14:20:00+00', 1.09200, 1.09800, 1.09000, -12, 2.0, 45000, 30.0, 'A'),
  (test_user_id, '101003', 'GBPJPY', 'buy', 0.8, '2025-01-04 08:30:00+00', 195.200, '2025-01-04 12:45:00+00', 195.800, 194.900, 196.000, -12, 1.2, 48000, 60.0, 'A'),
  (test_user_id, '101004', 'AUDUSD', 'buy', 1.2, '2025-01-05 11:00:00+00', 0.65400, '2025-01-05 16:30:00+00', 0.65800, 0.65100, 0.66000, -12, 0.8, 48000, 40.0, 'A'),
  (test_user_id, '101005', 'USDJPY', 'sell', 1.0, '2025-01-08 09:30:00+00', 149.800, '2025-01-08 14:00:00+00', 149.200, 150.100, 149.000, -12, 1.8, 58000, 60.0, 'A'),
  (test_user_id, '101006', 'EURUSD', 'buy', 1.5, '2025-01-09 10:00:00+00', 1.08200, '2025-01-09 15:30:00+00', 1.08800, 1.08000, 1.09000, -12, 2.5, 90000, 60.0, 'A'),
  (test_user_id, '101007', 'GBPJPY', 'sell', 0.8, '2025-01-10 08:45:00+00', 196.500, '2025-01-10 13:15:00+00', 195.800, 196.800, 195.500, -12, 1.5, 56000, 70.0, 'A'),
  (test_user_id, '101008', 'AUDUSD', 'sell', 1.0, '2025-01-11 12:00:00+00', 0.66200, '2025-01-11 17:00:00+00', 0.65700, 0.66500, 0.65500, -12, 1.0, 50000, 50.0, 'A'),
  (test_user_id, '101009', 'USDJPY', 'buy', 1.2, '2025-01-12 09:15:00+00', 148.300, '2025-01-12 14:45:00+00', 149.000, 148.000, 149.300, -12, 2.0, 84000, 70.0, 'A'),
  (test_user_id, '101010', 'EURUSD', 'sell', 1.5, '2025-01-15 10:30:00+00', 1.09800, '2025-01-15 16:00:00+00', 1.09100, 1.10100, 1.08900, -12, 3.0, 105000, 70.0, 'A');

  -- Dataset B: 2月 2025、15トレード、66.7%勝率
  INSERT INTO trades (user_id, ticket, item, side, size, open_time, open_price, close_time, close_price, sl, tp, commission, swap, profit, pips, dataset) VALUES
  (test_user_id, '102001', 'USDJPY', 'buy', 1.0, '2025-02-03 09:00:00+00', 149.200, '2025-02-03 15:30:00+00', 149.900, 148.900, 150.200, -12, 1.5, 68000, 70.0, 'B'),
  (test_user_id, '102002', 'EURUSD', 'sell', 1.5, '2025-02-04 10:15:00+00', 1.08800, '2025-02-04 14:20:00+00', 1.08500, 1.09100, 1.08300, -12, 2.0, 45000, 30.0, 'B'),
  (test_user_id, '102003', 'GBPUSD', 'buy', 1.2, '2025-02-05 08:30:00+00', 1.26200, '2025-02-05 12:45:00+00', 1.26600, 1.25900, 1.26800, -12, 1.2, 48000, 40.0, 'B'),
  (test_user_id, '102004', 'AUDUSD', 'buy', 1.0, '2025-02-06 11:00:00+00', 0.66100, '2025-02-06 16:30:00+00', 0.66500, 0.65800, 0.66800, -12, 0.8, 40000, 40.0, 'B'),
  (test_user_id, '102005', 'USDJPY', 'sell', 1.0, '2025-02-07 09:30:00+00', 150.500, '2025-02-07 14:00:00+00', 149.900, 150.800, 149.700, -12, 1.8, 58000, 60.0, 'B'),
  (test_user_id, '102006', 'EURUSD', 'buy', 1.5, '2025-02-10 10:00:00+00', 1.08100, '2025-02-10 15:30:00+00', 1.08700, 1.07900, 1.08900, -12, 2.5, 90000, 60.0, 'B'),
  (test_user_id, '102007', 'EURJPY', 'sell', 0.8, '2025-02-11 08:45:00+00', 162.800, '2025-02-11 13:15:00+00', 162.200, 163.100, 161.900, -12, 1.5, 48000, 60.0, 'B'),
  (test_user_id, '102008', 'AUDUSD', 'sell', 1.0, '2025-02-12 12:00:00+00', 0.66800, '2025-02-12 17:00:00+00', 0.67300, 0.66500, 0.67500, -12, 1.0, -50000, -50.0, 'B'),
  (test_user_id, '102009', 'USDJPY', 'buy', 1.2, '2025-02-13 09:15:00+00', 149.500, '2025-02-13 14:45:00+00', 150.200, 149.200, 150.500, -12, 2.0, 84000, 70.0, 'B'),
  (test_user_id, '102010', 'EURUSD', 'sell', 1.5, '2025-02-14 10:30:00+00', 1.09200, '2025-02-14 16:00:00+00', 1.09800, 1.08900, 1.10100, -12, 3.0, -90000, -60.0, 'B'),
  (test_user_id, '102011', 'GBPUSD', 'buy', 0.9, '2025-02-17 09:00:00+00', 1.26500, '2025-02-17 14:30:00+00', 1.27100, 1.26200, 1.27300, -12, 1.8, 54000, 60.0, 'B'),
  (test_user_id, '102012', 'USDJPY', 'sell', 1.0, '2025-02-18 10:15:00+00', 150.800, '2025-02-18 15:45:00+00', 151.300, 150.500, 151.500, -12, 2.2, -50000, -50.0, 'B'),
  (test_user_id, '102013', 'EURJPY', 'buy', 1.1, '2025-02-19 08:20:00+00', 161.500, '2025-02-19 13:40:00+00', 162.200, 161.200, 162.500, -12, 1.5, 70000, 70.0, 'B'),
  (test_user_id, '102014', 'AUDUSD', 'buy', 1.3, '2025-02-20 11:30:00+00', 0.66500, '2025-02-20 16:50:00+00', 0.66100, 0.66200, 0.66900, -12, 2.0, -52000, -40.0, 'B'),
  (test_user_id, '102015', 'EURUSD', 'sell', 1.2, '2025-02-21 09:45:00+00', 1.09500, '2025-02-21 14:15:00+00', 1.08900, 1.09800, 1.08700, -12, 2.8, 72000, 60.0, 'B');

  -- Dataset C: 3月 2025、20トレード、50%勝率
  INSERT INTO trades (user_id, ticket, item, side, size, open_time, open_price, close_time, close_price, sl, tp, commission, swap, profit, pips, dataset, setup) VALUES
  (test_user_id, '103001', 'USDJPY', 'buy', 1.0, '2025-03-03 09:00:00+00', 150.200, '2025-03-03 15:30:00+00', 150.900, 149.900, 151.200, -12, 1.5, 68000, 70.0, 'C', 'トレンドフォロー'),
  (test_user_id, '103002', 'EURUSD', 'sell', 1.5, '2025-03-04 10:15:00+00', 1.08500, '2025-03-04 14:20:00+00', 1.08900, 1.08200, 1.09100, -12, 2.0, -60000, -40.0, 'C', 'レンジ逆張り'),
  (test_user_id, '103003', 'GBPJPY', 'buy', 0.8, '2025-03-05 08:30:00+00', 196.800, '2025-03-05 12:45:00+00', 197.400, 196.500, 197.600, -12, 1.2, 48000, 60.0, 'C', 'ブレイクアウト'),
  (test_user_id, '103004', 'XAUUSD', 'buy', 0.5, '2025-03-06 11:00:00+00', 2080.50, '2025-03-06 16:30:00+00', 2090.00, 2075.00, 2095.00, -8, 0.5, 47500, 95.0, 'C', 'トレンドフォロー'),
  (test_user_id, '103005', 'USDJPY', 'sell', 1.0, '2025-03-07 09:30:00+00', 151.500, '2025-03-07 14:00:00+00', 152.000, 151.200, 152.200, -12, 1.8, -50000, -50.0, 'C', 'レンジ逆張り'),
  (test_user_id, '103006', 'BTCUSD', 'buy', 0.1, '2025-03-08 22:00:00+00', 65000.00, '2025-03-09 02:30:00+00', 66500.00, 64500.00, 67000.00, -15, 0.0, 150000, 1500.0, 'C', 'ブレイクアウト'),
  (test_user_id, '103007', 'GBPJPY', 'sell', 0.8, '2025-03-10 08:45:00+00', 198.200, '2025-03-10 13:15:00+00', 197.600, 198.500, 197.300, -12, 1.5, 48000, 60.0, 'C', 'トレンドフォロー'),
  (test_user_id, '103008', 'EURUSD', 'sell', 1.0, '2025-03-11 12:00:00+00', 1.09200, '2025-03-11 17:00:00+00', 1.09700, 1.08900, 1.09900, -12, 1.0, -50000, -50.0, 'C', 'レンジ逆張り'),
  (test_user_id, '103009', 'USDJPY', 'buy', 1.2, '2025-03-12 09:15:00+00', 151.000, '2025-03-12 14:45:00+00', 151.700, 150.700, 152.000, -12, 2.0, 84000, 70.0, 'C', 'トレンドフォロー'),
  (test_user_id, '103010', 'XAUUSD', 'sell', 0.5, '2025-03-13 10:30:00+00', 2095.00, '2025-03-13 16:00:00+00', 2100.00, 2090.00, 2105.00, -8, 0.5, -25000, -50.0, 'C', 'レンジ逆張り'),
  (test_user_id, '103011', 'GBPJPY', 'buy', 0.9, '2025-03-14 09:00:00+00', 197.500, '2025-03-14 14:30:00+00', 198.100, 197.200, 198.300, -12, 1.8, 54000, 60.0, 'C', 'ブレイクアウト'),
  (test_user_id, '103012', 'BTCUSD', 'sell', 0.1, '2025-03-15 18:15:00+00', 67000.00, '2025-03-15 23:45:00+00', 66000.00, 67500.00, 65500.00, -15, 0.0, 100000, 1000.0, 'C', 'トレンドフォロー'),
  (test_user_id, '103013', 'EURUSD', 'buy', 1.1, '2025-03-17 08:20:00+00', 1.08800, '2025-03-17 13:40:00+00', 1.08300, 1.08500, 1.09100, -12, 1.5, -55000, -50.0, 'C', 'レンジ逆張り'),
  (test_user_id, '103014', 'USDJPY', 'buy', 1.3, '2025-03-18 11:30:00+00', 151.500, '2025-03-18 16:50:00+00', 152.100, 151.200, 152.400, -12, 2.0, 78000, 60.0, 'C', 'トレンドフォロー'),
  (test_user_id, '103015', 'XAUUSD', 'buy', 0.5, '2025-03-19 09:45:00+00', 2085.00, '2025-03-19 14:15:00+00', 2075.00, 2080.00, 2095.00, -8, 0.5, -50000, -100.0, 'C', 'レンジ逆張り'),
  (test_user_id, '103016', 'GBPJPY', 'sell', 0.8, '2025-03-20 08:30:00+00', 198.800, '2025-03-20 13:50:00+00', 198.200, 199.100, 197.900, -12, 1.6, 48000, 60.0, 'C', 'ブレイクアウト'),
  (test_user_id, '103017', 'EURUSD', 'sell', 1.2, '2025-03-21 10:00:00+00', 1.09100, '2025-03-21 15:20:00+00', 1.09600, 1.08800, 1.09800, -12, 2.3, -60000, -50.0, 'C', 'レンジ逆張り'),
  (test_user_id, '103018', 'BTCUSD', 'buy', 0.1, '2025-03-22 20:00:00+00', 66500.00, '2025-03-23 01:30:00+00', 67500.00, 66000.00, 68000.00, -15, 0.0, 100000, 1000.0, 'C', 'ブレイクアウト'),
  (test_user_id, '103019', 'USDJPY', 'sell', 1.0, '2025-03-24 09:15:00+00', 152.300, '2025-03-24 14:45:00+00', 152.800, 152.000, 153.000, -12, 2.1, -50000, -50.0, 'C', 'レンジ逆張り'),
  (test_user_id, '103020', 'XAUUSD', 'sell', 0.5, '2025-03-25 10:30:00+00', 2100.00, '2025-03-25 16:00:00+00', 2095.00, 2105.00, 2090.00, -8, 0.5, 25000, 50.0, 'C', 'トレンドフォロー');

  -- アカウントサマリーデータを挿入（datasetごと）
  INSERT INTO account_summary (user_id, balance, equity, profit, deposit, withdraw, commission, swap, swap_long, swap_short, dataset)
  VALUES 
    (test_user_id, 1652000, 1652000, 652000, 1000000, 0, -120, 15, 8, 7, 'A'),
    (test_user_id, 2047500, 2047500, 395500, 0, 0, -180, 28, 15, 13, 'B'),
    (test_user_id, 2221500, 2221500, 174000, 0, 0, -240, 47, 22, 25, 'C')
  ON CONFLICT (user_id, dataset) DO UPDATE SET
    balance = EXCLUDED.balance,
    equity = EXCLUDED.equity,
    profit = EXCLUDED.profit,
    deposit = EXCLUDED.deposit,
    withdraw = EXCLUDED.withdraw,
    commission = EXCLUDED.commission,
    swap = EXCLUDED.swap,
    swap_long = EXCLUDED.swap_long,
    swap_short = EXCLUDED.swap_short,
    updated_at = NOW();

  -- アカウント取引履歴を挿入（datasetごと）
  DELETE FROM account_transactions WHERE user_id = test_user_id AND dataset IN ('A', 'B', 'C');
  
  INSERT INTO account_transactions (user_id, time, transaction_date, type, transaction_type, amount, balance, comment, swap_long, swap_short, dataset) VALUES
  (test_user_id, '2025-01-01 00:00:00+00', '2025-01-01 00:00:00+00', 'deposit', 'deposit', 1000000, 1000000, '初期入金', 0, 0, 'A'),
  (test_user_id, '2025-01-31 23:59:59+00', '2025-01-31 23:59:59+00', 'credit', 'credit', 652000, 1652000, '1月の利益', 8, 7, 'A'),
  (test_user_id, '2025-02-28 23:59:59+00', '2025-02-28 23:59:59+00', 'credit', 'credit', 395500, 2047500, '2月の利益', 15, 13, 'B'),
  (test_user_id, '2025-03-31 23:59:59+00', '2025-03-31 23:59:59+00', 'credit', 'credit', 174000, 2221500, '3月の利益', 22, 25, 'C');

END $$;